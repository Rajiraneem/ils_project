{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<style>
  .form-section {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 4px;
  }
  
  .form-section h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 1px solid #ddd;
    padding-bottom: 8px;
  }
  
  .help-text {
    color: #666;
    font-style: italic;
    margin-top: 5px;
    font-size: 13px;
  }
  
  .checkbox-label {
    display: flex;
    align-items: center;
    margin: 10px 0;
  }
  
  .checkbox-label input {
    margin-right: 10px;
  }
  
  /* Modal Styling */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
  }

  .modal-content {
    background-color: white;
    margin: 50px auto;
    padding: 20px;
    width: 80%;
    box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
    border-radius: 4px;
  }

  .button {
    padding: 10px 15px;
    font-size: 14px;
    color: #fff;
    background-color: #4CAF50;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 10px;
  }

  .button.preview {
    background-color: #2196F3;
  }

  .button:hover {
    background-color: #45a049;
  }

  .button.preview:hover {
    background-color: #1e88e5;
  }

  .button.close {
    background-color: #f44336;
  }
  
  .button.close:hover {
    background-color: #e53935;
  }
</style>
{% endblock %}

{% block content %}
<div id="content" class="colM">
  <h1>Customize PDF Report</h1>
  
  <div id="content-main">
    <p>Customize the content and appearance of the PDF report.</p>

    <form method="post" enctype="multipart/form-data" id="pdfCustomizationForm">
      {% csrf_token %}
      
      <!-- Report Title Section -->
      <div class="form-section">
        <h3>Report Title</h3>
        {{ form.title.errors }}
        <input type="text" name="title" id="id_title" value="{{ form.title.value|default:'' }}" class="form-control" placeholder="Enter the title of the report (e.g., Student Performance Report)" />
        <p class="help-text">This title will appear at the top of the PDF document.</p>
      </div>

      <!-- Additional Notes Section -->
      <div class="form-section">
        <h3>Additional Notes</h3>
        {{ form.notes.errors }}
        <textarea name="notes" id="id_notes" class="form-control" placeholder="Enter any additional notes or instructions">{{ form.notes.value|default:'' }}</textarea>
        <p class="help-text">Optional: Add any extra notes that you would like to appear below the title.</p>
      </div>

      <!-- Footer Text Section -->
      <div class="form-section">
        <h3>Footer Text</h3>
        {{ form.footer.errors }}
        <input type="text" name="footer" id="id_footer" value="{{ form.footer.value|default:'' }}" class="form-control" placeholder="Enter footer text (e.g., Generated by ILS System)" />
        <p class="help-text">This text will appear at the bottom of the PDF.</p>
      </div>

      <!-- Include Chart Section -->
      <div class="form-section">
        <h3>Include Performance Chart</h3>
        {{ form.include_chart.errors }}
        <label class="checkbox-label">
          <input type="checkbox" name="include_chart" id="id_include_chart" {% if form.include_chart.value %}checked{% endif %}>
          Yes, include the performance chart
        </label>
        <p class="help-text">Choose whether to include a performance chart showing student results.</p>
      </div>

      <!-- Logo Upload Section -->
      <div class="form-section">
        <h3>Logo Image</h3>
        {{ form.logo.errors }}
        <input type="file" name="logo" id="id_logo" class="form-control-file" />
        {% if form.logo.value %}<p>Current logo: {{ form.logo.value }}</p>{% endif %}
        <p class="help-text">Upload your institution's logo. It will appear at the top-left corner of the report.</p>
      </div>

      <!-- Signature Section -->
      <div class="form-section">
        <h3>Editable Signature</h3>
        {{ form.signature.errors }}
        <input type="text" name="signature" id="id_signature" value="{{ form.signature.value|default:'' }}" class="form-control" placeholder="Enter the signature text (e.g., Authorized Signature)" />
        <p class="help-text">Add a signature or any custom text to appear at the bottom of the document.</p>
      </div>

      <!-- Submit Buttons -->
      <div class="form-section">
        <button type="submit" class="button default" name="_save">Generate PDF</button>
        <button type="button" class="button preview" id="previewButton">Preview PDF</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal for PDF Preview -->
<div id="pdfPreviewModal" class="modal">
  <div class="modal-content">
    <h3>PDF Preview</h3>
    <embed id="pdfPreview" src="" type="application/pdf" width="100%" height="600px" />
    <button class="button close" id="closePreviewBtn">Close Preview</button>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle Preview PDF Button Click
    document.getElementById('previewButton').addEventListener('click', function() {
      const formData = new FormData(document.getElementById('pdfCustomizationForm'));
      
      // Add a flag to indicate this is a preview request
      formData.append('preview', 'true');

      // Make AJAX request to generate PDF preview
      fetch('/admin/omr_app/studentsubmission/{{ submission_id }}/pdf/preview/', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.blob();
      })
      .then(blob => {
        const url = URL.createObjectURL(blob);
        document.getElementById('pdfPreview').src = url;
        document.getElementById('pdfPreviewModal').style.display = 'block';
      })
      .catch(error => {
        console.error('Error generating preview:', error);
        alert('Error generating PDF preview. Please try again.');
      });
    });

    // Close Preview Modal
    document.getElementById('closePreviewBtn').addEventListener('click', function() {
      document.getElementById('pdfPreviewModal').style.display = 'none';
      // Revoke the object URL to free up memory
      URL.revokeObjectURL(document.getElementById('pdfPreview').src);
    });
    
    // Close modal if user clicks outside the modal content
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('pdfPreviewModal');
      if (event.target === modal) {
        modal.style.display = 'none';
        URL.revokeObjectURL(document.getElementById('pdfPreview').src);
      }
    });
  });
</script>
{% endblock %}